name: Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.4)'
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  wait-for-version-sync:
    name: Wait for Version Sync
    runs-on: ubuntu-latest
    # Only run this job when triggered by release event (not manual)
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Wait for version sync workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "Waiting for version sync workflow to complete for tag $RELEASE_TAG..."
          # Wait up to 5 minutes for the version sync workflow
          for i in {1..60}; do
            # Find the version sync run triggered by this release
            RESULT=$(gh run list --workflow=release-version-sync.yml --limit 5 --json status,conclusion,headBranch,createdAt --jq '.[0]')
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')
            echo "Attempt $i/60: Version sync status: $STATUS (conclusion: $CONCLUSION)"
            
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "Version sync completed successfully!"
                exit 0
              else
                echo "ERROR: Version sync completed with conclusion: $CONCLUSION"
                exit 1
              fi
            fi
            
            sleep 5
          done
          
          echo "ERROR: Version sync workflow did not complete within 5 minutes"
          exit 1

  build-release:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    # Wait for version sync when triggered by release, skip for manual
    needs: [wait-for-version-sync]
    if: always() && (needs.wait-for-version-sync.result == 'success' || github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: jarvis
            asset_name: jarvis-linux-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: jarvis
            asset_name: jarvis-macos-aarch64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # For release events, checkout main (which has updated version)
          # For manual dispatch, checkout the specified tag
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || 'main' }}

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0
        with:
          enable-cache: true

      - name: Add Rust target (if needed)
        if: matrix.target == 'aarch64-apple-darwin'
        run: rustup target add ${{ matrix.target }}

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: |
          if [ "$BUILD_TARGET" = "aarch64-apple-darwin" ]; then
            cargo build --release --target "$BUILD_TARGET"
          else
            devbox run release
          fi

      - name: Prepare binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
          ASSET_NAME: ${{ matrix.asset_name }}
        run: |
          if [ "$BUILD_TARGET" = "aarch64-apple-darwin" ]; then
            cp "target/$BUILD_TARGET/release/$ARTIFACT_NAME" "$ASSET_NAME"
          else
            cp "target/release/$ARTIFACT_NAME" "$ASSET_NAME"
          fi
          chmod +x "$ASSET_NAME"

      - name: Create tarball
        env:
          ASSET_NAME: ${{ matrix.asset_name }}
        run: |
          tar -czf "$ASSET_NAME.tar.gz" "$ASSET_NAME"

      - name: Generate SHA256 checksums
        env:
          ASSET_NAME: ${{ matrix.asset_name }}
        run: |
          if command -v sha256sum &> /dev/null; then
            sha256sum "$ASSET_NAME" > "$ASSET_NAME.sha256"
            sha256sum "$ASSET_NAME.tar.gz" > "$ASSET_NAME.tar.gz.sha256"
          else
            shasum -a 256 "$ASSET_NAME" > "$ASSET_NAME.sha256"
            shasum -a 256 "$ASSET_NAME.tar.gz" > "$ASSET_NAME.tar.gz.sha256"
          fi

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.event.release.tag_name }}
          ASSET_NAME: ${{ matrix.asset_name }}
        run: |
          gh release upload "$RELEASE_TAG" \
            "$ASSET_NAME" \
            "$ASSET_NAME.sha256" \
            "$ASSET_NAME.tar.gz" \
            "$ASSET_NAME.tar.gz.sha256" \
            --clobber
